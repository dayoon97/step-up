<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Project">

	<!-- Project_List 테이블 -->
	<resultMap type="com.stepup.agile.projectManage.model.vo.Project" id="projectResultSet">
		<id property="projectCode" column="PROJECT_CODE"/>
		<result property="projectName" column="PROJECT_NAME"/>
		<result property="createDate" column="PROJECT_CREATE_DATE"/>
		<result property="createTime" column="PROJECT_CREATE_TIME"/>
		<collection property="userProjectList" resultMap="UserProjectListResultSet"/>
		<collection property="userTeamList" resultMap="UserTeamListResultSet"/>
		<collection property="member" resultMap="memberResultSet"/>
		<collection property="projectHistory" resultMap="projectHistoryResultSet"/>
		<collection property="team" resultMap="TeamResultSet"/>
	</resultMap>

	<resultMap type="com.stepup.agile.projectManage.model.vo.ProjectHistory" id="projectHistoryResultSet">
		<id property="projectHistCode" column="PROJECT_HIST_CODE"/>
		<result property="projectHistDate" column="PROJECT_HIST_DATE"/>
		<result property="projectStatus" column="PROJECT_STATUS"/>
		<result property="projectStartDate" column="PROJECT_START_DATE"/>
		<result property="projectEndDate" column="PROJECT_END_DATE"/>
		<result property="projectCode" column="PROJECT_CODE"/>
		<result property="projectHistTime" column="PROJECT_HIST_TIME"/>
		<result property="projectIntro" column="PROJECT_INTRO"/>
		<result property="projectStartTime" column="PROJECT_START_TIME"/>
		<result property="projectEndTime" column="PROJECT_END_TIME"/>
	</resultMap>

	<!-- 사용자정보  -->
	<resultMap type="com.stepup.agile.userInfo.model.vo.Member" id="memberResultSet">
		<id property="userCode" column="USER_CODE"/>
		<result property="userEmail" column="USER_EMAIL"/>
		<result property="userPwd" column="USER_PWD"/>
		<result property="userName" column="USER_NAME"/>
		<result property="userPhone" column="USER_PHONE"/>
		<result property="userCompName" column="USER_COMP_NAME"/>
		<result property="userCompDept" column="USER_COMP_DEPT"/>
		<result property="userCompJob" column="USER_COMP_JOB"/>
		<result property="userEnrollDate" column="USER_ENROLL_DATE"/>
		<result property="userStatus" column="USER_STATUS"/>
		<result property="userManagerYn" column="USER_MANAGER_YN"/>
		<result property="userEnrollTime" column="USER_ENROLL_TIME"/>
	</resultMap>
	
	<resultMap type="com.stepup.agile.userInfo.model.vo.UserProjectList" id="UserProjectListResultSet">
		<id property="userProjectCode" column="USER_PROJECT_CODE"/>
		<result property="userProjectUpdateDate" column="USER_PROJECT_UPDATE_DATE"/>
		<result property="userProjectUpdateTime" column="USER_PROJECT_UPDATE_TIME"/>
		<result property="userProjectStatus" column="USER_PROJECT_STATUS"/>
		<result property="projectCode" column="PROJECT_CODE"/>
		<result property="userTeamCode" column="USER_TEAM_CODE"/>
		<result property="userProjectAuthority" column="USER_PROJECT_AUTHORITY"/>
	</resultMap>
	
	<!-- 팀소속이력관리 -->
	<resultMap type="com.stepup.agile.userInfo.model.vo.UserTeamList" id="UserTeamListResultSet">
		<id property="userTeamCode" column="USER_TEAM_CODE"/>
		<result property="userTeamDate" column="USER_TEAM_DATE"/>
		<result property="userTeamYn" column="USER_TEAM_YN"/>
		<result property="userCode" column="USER_CODE"/>
		<result property="teamCode" column="TEAM_CODE"/>
		<result property="userTeamTime" column="USER_TEAM_TIME"/>
	</resultMap>

	<!-- 팀코드-팀명 -->
	<resultMap type="com.stepup.agile.userInfo.model.vo.Team" id="TeamResultSet">
		<id property="teamCode" column="TEAM_CODE"/>
		<result property="teamName" column="TEAM_NAME"/>
	</resultMap>
	

	<resultMap id="selectUserPJRset" type="com.stepup.agile.projectManage.model.vo.Project">
		<id property="projectCode" column="PROJECT_CODE"/>
		<result property="projectName" column="PROJECT_NAME"/>
		<result property="createDate" column="PROJECT_CREATE_DATE"/>
		<result property="createTime" column="PROJECT_CREATE_TIME"/>
		<result property="taskCnt" column="TASKCNT"/>
    <collection property="member" resultMap="memberResultSet"/>
    <collection property="userTeamList" resultMap="UserTeamListResultSet"/>
    <collection property="userProjectList" resultMap="UserProjectListResultSet"/>
		
	</resultMap>
	
	
	
	<select id="selectUserProject" resultMap="selectUserPJRset" parameterType="Project">
	 	SELECT *
	    FROM (SELECT PL.PROJECT_NAME
			  FROM USER_INFO I,
			       USER_TEAM_LIST T,
			       USER_PROJECT_LIST P,
			       PROJECT_LIST PL
			 WHERE I.USER_CODE = T.USER_CODE
			   AND T.USER_TEAM_CODE = P.USER_TEAM_CODE
			   AND P.USER_PROJECT_CODE = PL.PROJECT_CODE
			   AND I.USER_CODE = (SELECT USER_CODE 
	                                FROM USER_INFO
	                               WHERE USER_EMAIL = #{userEmail, jdbcType=VARCHAR})) A
	    LEFT JOIN (SELECT COUNT(TASK_HIST_VALUE) AS TASKCNT, PROJECT_NAME
	          FROM (SELECT TK.TASK_CODE, PS.PROJECT_NAME
	                     , MAX(TS.TASK_HIST_VALUE) KEEP (DENSE_RANK LAST ORDER BY TS.TASK_HIST_UPDATE_DATE, TS.TASK_HIST_UPDATE_TIME) AS TASK_HIST_VALUE
	                  FROM USER_INFO I,
	                       USER_TEAM_LIST T,
	                       USER_PROJECT_LIST P,
	                       SPRINT_LIST S,
	                       TASK_LIST TK,
	                       TASK_HISTORY TS,
	                       PROJECT_LIST PS
	                 WHERE I.USER_CODE = T.USER_CODE
	                   AND T.USER_TEAM_CODE = P.USER_TEAM_CODE
	                   AND P.USER_PROJECT_CODE = S.USER_PROJECT_CODE
	                   AND P.PROJECT_CODE = PS.PROJECT_CODE
	                   AND S.SPRINT_CODE = TK.SPRINT_CODE
	                   AND TK.TASK_CODE = TS.TASK_CODE
	                   AND I.USER_CODE = 14
	                   AND TS.TASK_CATEGORY_CODE = 'I'
	              GROUP BY TK.TASK_CODE, TS.TASK_CATEGORY_CODE, PS.PROJECT_NAME)
	          WHERE TASK_HIST_VALUE LIKE '%미진행%'
	          GROUP BY PROJECT_NAME) B                         
	    ON (A.PROJECT_NAME = B.PROJECT_NAME)
	</select>
	
	<select id="selectUserProject2" resultMap="selectUserPJRset" parameterType="Project">
	 	SELECT *
	    FROM (SELECT PL.PROJECT_NAME
			  FROM USER_INFO I,
			       USER_TEAM_LIST T,
			       USER_PROJECT_LIST P,
			       PROJECT_LIST PL
			 WHERE I.USER_CODE = T.USER_CODE
			   AND T.USER_TEAM_CODE = P.USER_TEAM_CODE
			   AND P.USER_PROJECT_CODE = PL.PROJECT_CODE
			   AND I.USER_CODE = (SELECT USER_CODE 
	                                FROM USER_INFO
	                               WHERE USER_EMAIL = #{userEmail, jdbcType=VARCHAR})) A
	    LEFT JOIN (SELECT COUNT(TASK_HIST_VALUE) AS TASKCNT, PROJECT_NAME
	          FROM (SELECT TK.TASK_CODE, PS.PROJECT_NAME
	                     , MAX(TS.TASK_HIST_VALUE) KEEP (DENSE_RANK LAST ORDER BY TS.TASK_HIST_UPDATE_DATE, TS.TASK_HIST_UPDATE_TIME) AS TASK_HIST_VALUE
	                  FROM USER_INFO I,
	                       USER_TEAM_LIST T,
	                       USER_PROJECT_LIST P,
	                       SPRINT_LIST S,
	                       TASK_LIST TK,
	                       TASK_HISTORY TS,
	                       PROJECT_LIST PS
	                 WHERE I.USER_CODE = T.USER_CODE
	                   AND T.USER_TEAM_CODE = P.USER_TEAM_CODE
	                   AND P.USER_PROJECT_CODE = S.USER_PROJECT_CODE
	                   AND P.PROJECT_CODE = PS.PROJECT_CODE
	                   AND S.SPRINT_CODE = TK.SPRINT_CODE
	                   AND TK.TASK_CODE = TS.TASK_CODE
	                   AND I.USER_CODE = 14
	                   AND TS.TASK_CATEGORY_CODE = 'I'
	              GROUP BY TK.TASK_CODE, TS.TASK_CATEGORY_CODE, PS.PROJECT_NAME)
	          WHERE TASK_HIST_VALUE LIKE '%진행중%'
	          GROUP BY PROJECT_NAME) B                         
	    ON (A.PROJECT_NAME = B.PROJECT_NAME)
	</select>
	
	
	
	
	<!-- miso1 -->
	<!-- Project Insert -->
	<insert id="insertProject" parameterType="Project">
		INSERT INTO PROJECT_LIST
		VALUES (SEQ_PROJECT.NEXTVAL, #{projectName},TO_CHAR(SYSDATE + 9/24, 'YYYY-MM-DD'),TO_CHAR(SYSDATE + 9/24, 'hh24:mi:ss'))
	</insert>
	
	<!-- ProjectList Select -->
	<select id="selectProjectList" resultMap="projectResultSet" parameterType="Project">
		SELECT 
		    I.USER_CODE, I.USER_NAME,
		    J.PROJECT_CODE, J.PROJECT_NAME,
		    P.USER_PROJECT_AUTHORITY,P.USER_PROJECT_CODE,
		    PH.PROJECT_START_DATE, PH.PROJECT_START_TIME, PH.PROJECT_END_DATE, PH.PROJECT_END_TIME
		    FROM USER_PROJECT_LIST P, PROJECT_HISTORY PH, PROJECT_LIST J, USER_INFO I,USER_TEAM_LIST T
		    WHERE T.USER_TEAM_CODE = P.USER_TEAM_CODE
		    AND P.PROJECT_CODE = J.PROJECT_CODE 
		    AND J.PROJECT_CODE = PH.PROJECT_CODE
		    AND I.USER_CODE  = T.USER_CODE
		    AND T.USER_TEAM_YN = 'Y'
		    AND J.PROJECT_CODE IN (SELECT J.PROJECT_CODE
		                             FROM USER_INFO I,
		                                  USER_TEAM_LIST T,
		                                  USER_PROJECT_LIST P,
		                                  PROJECT_LIST J,
		                                  PROJECT_HISTORY H
		                            WHERE I.USER_CODE  = T.USER_CODE
		                              AND T.USER_TEAM_YN = 'Y' 
		                              AND T.USER_TEAM_CODE = P.USER_TEAM_CODE
		                              AND P.PROJECT_CODE = J.PROJECT_CODE
		                              AND J.PROJECT_CODE = H.PROJECT_CODE 
		                              AND H.PROJECT_STATUS = 'N'
		                              AND I.USER_EMAIL = #{userEmail, jdbcType=VARCHAR})
		    ORDER BY J.PROJECT_CODE
	</select>
	
	<select id="selectProjectProceedingRate" resultMap="projectResultSet" parameterType="Project" resultType="hashmap">
	SELECT SPRINT_HIST_CODE, SPRINT_HIST_UPDATE_DATE, SPRINT_HIST_UPDATE_TIME, SPRINT_TYPE, SPRINT_CODE, PROJECT_CODE
      FROM (SELECT SH.SPRINT_HIST_CODE, SH.SPRINT_HIST_UPDATE_DATE, SH.SPRINT_HIST_UPDATE_TIME, SH.SPRINT_TYPE, SH.SPRINT_CODE, UPL.PROJECT_CODE,
			RANK() OVER (PARTITION BY SH.SPRINT_CODE ORDER BY SH.SPRINT_HIST_UPDATE_DATE DESC, SH.SPRINT_HIST_UPDATE_TIME DESC) LATEST
			  FROM SPRINT_HISTORY SH, SPRINT_LIST S, USER_PROJECT_LIST UPL
		     WHERE SH.SPRINT_CODE = S.SPRINT_CODE
		       AND S.USER_PROJECT_CODE = UPL.USER_PROJECT_CODE) 
     WHERE LATEST = 1;
	</select>

</mapper>